
syntax = "proto3";
package rexecd;

service Rexecd {
  rpc Command(CommandRequest) returns (stream CommandResponse) {}
  rpc RegisterHost(RegisterHostRequest) returns (RegisterHostResponse) {}
  rpc RegisterUser(RegisterUserRequest) returns (RegisterUserResponse) {}
}

message UserExecDataRequest {
  string username = 1;
  string host_id = 2;
  int32 index = 3;
}

message UserExecDataResponse {
  Line stdout_line = 1;
  Line stderr_line = 2;
  bool done = 3;
}

message Line {
  bytes line = 1;
  int64 time = 2;
}

message CommandRequest {
  string cmd = 1;
  string username = 2;
  repeated HostConfig host_config = 3;
  map<string,string> env = 4;
}

message HostConfig {
  string host_id = 1;
  string address = 2;
  string port = 3;
}

message CommandResponse {
  HostConfig host_config = 1;
  bytes stdout = 2;
  bytes stderr = 3;
  Exit exit = 4;
}

message Exit {
  string msg = 1;
  int32 status = 2;
}


message RegisterHostRequest {
  string host_id = 1;
  bytes public_key = 2;
  // Must be specified for host key verification. One of the following:
  //
  // ssh-rsa
  // ssh-dss
  // ecdsa-sha2-nistp256
  // ecdsa-sha2-nistp384
  // ecdsa-sha2-nistp521
  // ssh-ed25519
  // ssh-rsa
  // rsa-sha2-256
  // rsa-sha2-512
  string key_type = 3;
}

message RegisterHostResponse {}

message RegisterUserRequest {
  string username = 1;
  bytes private_key = 2;
  bytes public_key = 3;
}

message RegisterUserResponse {}
